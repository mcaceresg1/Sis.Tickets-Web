<!-- Modal Backdrop -->
<div class="modal-backdrop" *ngIf="mostrarModal" (click)="cerrarModal()"></div>

<!-- Modal -->
<div class="modal" *ngIf="mostrarModal">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h2>Actualizar Ticket #{{ ticketId }}</h2>
        <button class="btn-close" (click)="cerrarModal()" type="button">×</button>
      </div>

      <!-- Body -->
      <div class="modal-body">
        <!-- Loading inicial -->
        <div class="loading-container" *ngIf="loadingTicket">
          <div class="spinner-border"></div>
          <p>Cargando datos del ticket...</p>
        </div>

        <!-- Mensajes de éxito/error -->
        <div class="alert alert-success" *ngIf="successMessage">
          {{ successMessage }}
        </div>

        <div class="alert alert-error" *ngIf="errorMessage">
          {{ errorMessage }}
        </div>

        <!-- Formulario -->
        <form [formGroup]="ticketForm" (ngSubmit)="actualizarTicket()" *ngIf="!loadingTicket">
          <div class="form-row">
            <!-- Código -->
            <div class="form-group col-md-6">
              <label for="codigo">Código <span class="required">*</span></label>
              <input
                type="text"
                id="codigo"
                class="form-control"
                formControlName="codigo"
                placeholder="Ej: TKT-2025-001"
                maxlength="20"
                [class.is-invalid]="campoEsInvalido('codigo')"
              />
              <div class="invalid-feedback" *ngIf="campoEsInvalido('codigo')">
                {{ obtenerMensajeError('codigo') }}
              </div>
              <small class="form-text">Máximo 20 caracteres</small>
            </div>

            <!-- Sistema -->
            <div class="form-group col-md-6">
              <label for="idSistema">Sistema <span class="required">*</span></label>
              <select
                id="idSistema"
                class="form-control"
                formControlName="idSistema"
                [class.is-invalid]="campoEsInvalido('idSistema')"
              >
                <option [ngValue]="null">Seleccione un sistema</option>
                <option *ngFor="let sistema of sistemas" [ngValue]="sistema.Id">
                  {{ sistema.Descripcion }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="campoEsInvalido('idSistema')">
                {{ obtenerMensajeError('idSistema') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <!-- Módulo -->
            <div class="form-group col-md-6">
              <label for="idModulo">Módulo <span class="required">*</span></label>
              <select
                id="idModulo"
                class="form-control"
                formControlName="idModulo"
                [disabled]="!ticketForm.value.idSistema || modulos.length === 0"
                [class.is-invalid]="campoEsInvalido('idModulo')"
              >
                <option [ngValue]="null">Seleccione un módulo</option>
                <option *ngFor="let modulo of modulos" [ngValue]="modulo.Id">
                  {{ modulo.Descripcion }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="campoEsInvalido('idModulo')">
                {{ obtenerMensajeError('idModulo') }}
              </div>
            </div>

            <!-- Página -->
            <div class="form-group col-md-6">
              <label for="idPagina">Página <span class="required">*</span></label>
              <select
                id="idPagina"
                class="form-control"
                formControlName="idPagina"
                [disabled]="!ticketForm.value.idModulo || paginas.length === 0"
                [class.is-invalid]="campoEsInvalido('idPagina')"
              >
                <option [ngValue]="null">Seleccione una página</option>
                <option *ngFor="let pagina of paginas" [ngValue]="pagina.Id">
                  {{ pagina.Descripcion }}
                </option>
              </select>
              <div class="invalid-feedback" *ngIf="campoEsInvalido('idPagina')">
                {{ obtenerMensajeError('idPagina') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <!-- Tipo de Incidencia -->
            <div class="form-group col-md-6">
              <label for="idTipo">Tipo de Incidencia</label>
              <select
                id="idTipo"
                class="form-control"
                formControlName="idTipo"
              >
                <option [ngValue]="null">Seleccione un tipo</option>
                <option *ngFor="let tipo of tiposIncidencia" [ngValue]="tipo.Id">
                  {{ tipo.Descripcion }}
                </option>
              </select>
            </div>
            
            <!-- Estado -->
            <div class="form-group col-md-6">
              <label for="idEstado">Estado</label>
              <select
                id="idEstado"
                class="form-control"
                formControlName="idEstado"
              >
                <option [ngValue]="null">Seleccione un estado</option>
                <option *ngFor="let estado of estados" [ngValue]="estado.Id">
                  {{ estado.Descripcion }}
                </option>
              </select>
            </div>

            <!-- Prioridad -->
            <div class="form-group col-md-6">
              <label for="idPrioridad">Prioridad</label>
              <select
                id="idPrioridad"
                class="form-control"
                formControlName="idPrioridad"
              >
                <option [ngValue]="null">Seleccione una prioridad</option>
                <option *ngFor="let prioridad of prioridades" [ngValue]="prioridad.Id">
                  {{ prioridad.Descripcion }}
                </option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <!-- Impacto -->
            <div class="form-group col-md-6">
              <label for="idImpacto">Impacto</label>
              <select
                id="idImpacto"
                class="form-control"
                formControlName="idImpacto"
              >
                <option [ngValue]="null">Seleccione un impacto</option>
                <option *ngFor="let impacto of impactos" [ngValue]="impacto.Id">
                  {{ impacto.Descripcion }}
                </option>
              </select>
            </div>
          </div>

          <!-- Descripción -->
          <div class="form-group">
            <label for="descripcion">Descripción <span class="required">*</span></label>
            <textarea
              id="descripcion"
              class="form-control"
              formControlName="descripcion"
              rows="5"
              placeholder="Describa detalladamente el ticket..."
              [class.is-invalid]="campoEsInvalido('descripcion')"
            ></textarea>
            <div class="invalid-feedback" *ngIf="campoEsInvalido('descripcion')">
              {{ obtenerMensajeError('descripcion') }}
            </div>
          </div>

          <!-- Información adicional del ticket -->
          <div class="ticket-info" *ngIf="ticketActual">
            <div class="info-row">
              <span class="info-label">Fecha de creación:</span>
              <span class="info-value">{{ ticketActual.dfechaTicket }}</span>
            </div>
            <div class="info-row" *ngIf="ticketActual.sVersion">
              <span class="info-label">Versión:</span>
              <span class="info-value">{{ ticketActual.sVersion }}</span>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="cerrarModal()"
          [disabled]="loading"
        >
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="actualizarTicket()"
          [disabled]="loading || loadingTicket || ticketForm.invalid"
        >
          <span *ngIf="!loading">Actualizar Ticket</span>
          <span *ngIf="loading">
            <span class="spinner-border spinner-border-sm mr-2"></span>
            Actualizando...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>

